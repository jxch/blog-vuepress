pipeline {
  agent none

  options {
    timestamps()
    disableConcurrentBuilds()
    timeout(time: 30, unit: 'MINUTES')
  }

  environment {
    NODE_ENV = 'production'
  }

  stages {
    stage('Build (Node in Docker)') {
      agent {
        docker {
          image 'node:24-slim'
          args  '-u root:root'
        }
      }

      steps {
        // 确保源码是在这个 Node 容器里检出
        checkout scm

        // 诊断：确认 package.json 确实在当前目录
        sh '''#!/usr/bin/env bash
          set -euxo pipefail
          echo "WORKSPACE=$WORKSPACE"
          pwd
          ls -la
          test -f package.json
        '''

        sh '''#!/usr/bin/env bash
          set -euxo pipefail

          node -v
          npm -v

          npm config set cache "$WORKSPACE/.npm-cache" --global

          if [ -f package-lock.json ]; then
            npm ci --prefer-offline --no-audit
          else
            npm install --prefer-offline --no-audit
          fi

          npm run build
        '''
      }

      post {
        always {
          // 如果你 build 输出不是 dist，而是 .vuepress/dist，需要改这里
          archiveArtifacts artifacts: 'dist/**', fingerprint: true, allowEmptyArchive: true
        }
      }
    }
  }

  post {
    always {
      echo "Build finished: ${currentBuild.currentResult}"
    }
  }
}