pipeline {
  agent none

  options {
    timestamps()
    disableConcurrentBuilds()
    timeout(time: 30, unit: 'MINUTES')
  }

  environment {
    NODE_ENV = 'production'
  }

  stages {
    stage('Build (Node in Docker)') {
      agent {
        docker {
          image 'node:24-slim'
          args  '-u root:root'
        }
      }

      steps {
        checkout scm

        // 诊断：确认项目在 main/ 下
        sh '''#!/usr/bin/env bash
          set -euxo pipefail
          echo "WORKSPACE=$WORKSPACE"
          pwd
          ls -la
          ls -la main
          test -f main/package.json
        '''

        // 等价于：cd main
        dir('main') {
          sh '''#!/usr/bin/env bash
            set -euxo pipefail

            node -v
            npm -v

            npm config set cache "$WORKSPACE/.npm-cache" --global

            if [ -f package-lock.json ]; then
              npm ci --prefer-offline --no-audit
            else
              npm install --prefer-offline --no-audit
            fi

            npm run build
          '''
        }
      }

      post {
        always {
          // VuePress 常见输出目录：main/.vuepress/dist
          archiveArtifacts artifacts: 'main/.vuepress/dist/**', fingerprint: true, allowEmptyArchive: true
        }
      }
    }
  }

  post {
    always {
      echo "Build finished: ${currentBuild.currentResult}"
    }
  }
}